# AREA Components Documentation

## Table of Contents
1. [Component Overview](#component-overview)
2. [Clock Service Components](#clock-service-components)
3. [Email Service Components](#email-service-components)
4. [Database Structure](#database-structure)
5. [Component Implementation Guide](#component-implementation-guide)

## Component Overview

Components in the AREA system are modular building blocks that define available actions (triggers) and reactions (effects). Each component belongs to a service and can have multiple configurable variables.

### Component Types
- **ACTION**: Triggers that start an automation (e.g., timers, webhooks)
- **REACTION**: Effects that are executed when triggered (e.g., send email, post message)

### Variable Types
- **PARAMETER**: User-configurable input values
- **OUTPUT**: Values generated by actions for use in reactions

---

## Clock Service Components

The Clock Service provides time-based triggers for automation workflows.

### 1. Daily Timer (`daily_timer`)

**Purpose**: Triggers an AREA at the same time every day.

**Type**: ACTION

**Description**: A simple daily recurring timer that triggers at a specified time each day. Ideal for daily reminders, reports, or routine tasks.

**Database Configuration**:

#### Service Record
```sql
INSERT INTO services (name, description, icon_path, requires_auth, is_active) 
VALUES ('Clock', 'Time-based triggers and actions for automation workflows', '/icons/clock.svg', false, true);
```

#### Component Record
```sql
INSERT INTO components (service_id, type, name, description, is_active, polling_interval)
VALUES (1, 'action', 'daily_timer', 'Triggers at the same time every day', true, 60000);
```

#### Variables Required
| Variable | Type | Required | Description | Example | Validation |
|----------|------|----------|-------------|---------|------------|
| `time` | STRING | Yes | Time of day in HH:MM format (24-hour) | "09:30" | `^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$` |

#### Variable Database Records
```sql
INSERT INTO variables (component_id, name, description, kind, type, nullable, placeholder, validation_regex, display_order)
VALUES (1, 'time', 'Time of day to trigger (HH:MM format, 24-hour)', 'parameter', 'string', false, '09:30', '^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$', 1);
```

**Usage Example**:
- User wants to receive a daily email at 9:30 AM
- Set `time` parameter to "09:30"
- AREA will trigger every day at 9:30 AM

---

### 2. Weekly Timer (`weekly_timer`)

**Purpose**: Triggers an AREA at specific times on specific days of the week.

**Type**: ACTION

**Description**: A weekly recurring timer that allows users to specify which days of the week and what time to trigger. Perfect for business day schedules or weekend reminders.

**Database Configuration**:

#### Component Record
```sql
INSERT INTO components (service_id, type, name, description, is_active, polling_interval)
VALUES (1, 'action', 'weekly_timer', 'Triggers at a specific time on specific days of the week', true, 60000);
```

#### Variables Required
| Variable | Type | Required | Description | Example | Validation |
|----------|------|----------|-------------|---------|------------|
| `time` | STRING | Yes | Time of day in HH:MM format (24-hour) | "09:30" | `^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$` |
| `days_of_week` | STRING | Yes | Comma-separated days of week | "monday,friday" | None |

#### Variable Database Records
```sql
INSERT INTO variables (component_id, name, description, kind, type, nullable, placeholder, validation_regex, display_order) VALUES
(2, 'time', 'Time of day to trigger (HH:MM format, 24-hour)', 'parameter', 'string', false, '09:30', '^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$', 1),
(2, 'days_of_week', 'Days of week to trigger (comma-separated: monday,tuesday,wednesday,thursday,friday,saturday,sunday)', 'parameter', 'string', false, 'monday,friday', null, 2);
```

**Usage Example**:
- User wants to receive a weekly report on Monday and Friday at 10:00 AM
- Set `time` to "10:00"
- Set `days_of_week` to "monday,friday"

**Valid Day Values**: monday, tuesday, wednesday, thursday, friday, saturday, sunday

---

### 3. Monthly Timer (`monthly_timer`)

**Purpose**: Triggers an AREA at specific times on specific days of the month.

**Type**: ACTION

**Description**: A monthly recurring timer for end-of-month reports, monthly billing reminders, or periodic maintenance tasks.

**Database Configuration**:

#### Component Record
```sql
INSERT INTO components (service_id, type, name, description, is_active, polling_interval)
VALUES (1, 'action', 'monthly_timer', 'Triggers at a specific time on specific days of the month', true, 60000);
```

#### Variables Required
| Variable | Type | Required | Description | Example | Validation |
|----------|------|----------|-------------|---------|------------|
| `time` | STRING | Yes | Time of day in HH:MM format (24-hour) | "09:30" | `^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$` |
| `days_of_month` | STRING | Yes | Comma-separated days of month or "last" | "1,15" or "last" | None |

#### Variable Database Records
```sql
INSERT INTO variables (component_id, name, description, kind, type, nullable, placeholder, validation_regex, display_order) VALUES
(3, 'time', 'Time of day to trigger (HH:MM format, 24-hour)', 'parameter', 'string', false, '09:30', '^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$', 1),
(3, 'days_of_month', 'Days of month to trigger (comma-separated: 1,15,30 or "last" for last day)', 'parameter', 'string', false, '1,15', null, 2);
```

**Usage Example**:
- User wants a monthly reminder on the 1st and 15th at 2:00 PM
- Set `time` to "14:00"
- Set `days_of_month` to "1,15"

**Special Values**:
- `last`: Triggers on the last day of the month
- Numbers 1-31: Specific days (invalid days like 31 in February are skipped)

---

### 4. Interval Timer (`interval_timer`)

**Purpose**: Triggers an AREA at regular intervals throughout the day.

**Type**: ACTION

**Description**: Repeats at specified intervals starting from a specified time until end of day. Supports both legacy minute-based intervals and flexible unit-based intervals (minutes, hours, days). Useful for periodic checks, status updates, or recurring notifications.

**Database Configuration**:

#### Component Record
```sql
INSERT INTO components (service_id, type, name, description, is_active, polling_interval)
VALUES (1, 'action', 'interval_timer', 'Triggers at regular intervals', true, 60000);
```

#### Variables Required (Current Implementation)
| Variable | Type | Required | Description | Example | Validation |
|----------|------|----------|-------------|---------|------------|
| `interval_minutes` | NUMBER | Yes | Minutes between each trigger | 30 | None |
| `start_time` | STRING | Yes | Time to start intervals (HH:MM format) | "09:00" | `^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$` |

#### Variable Database Records (Current Implementation)
```sql
INSERT INTO variables (component_id, name, description, kind, type, nullable, placeholder, validation_regex, display_order) VALUES
(4, 'interval_minutes', 'Interval in minutes between triggers', 'parameter', 'number', false, '30', null, 1),
(4, 'start_time', 'Time to start the interval (HH:MM format, 24-hour)', 'parameter', 'string', false, '09:00', '^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$', 2);
```

#### Extended Variables (Supported but Not Initialized)
The code also supports flexible interval parameters, but these are not currently created by the services initializer:

| Variable | Type | Required | Description | Example | Validation |
|----------|------|----------|-------------|---------|------------|
| `interval_unit` | STRING | Alternative | Unit of time (minutes, hours, days) | "hours" | None |
| `interval_value` | NUMBER | Alternative | Number of units between triggers | 2 | None |

**Usage Examples**:

**Current System (Legacy)**:
- User wants a status check every 30 minutes starting at 9:00 AM
- Set `interval_minutes` to 30
- Set `start_time` to "09:00"
- Will trigger at: 09:00, 09:30, 10:00, 10:30, etc.

**Extended System (Code Supported but Not Initialized)**:
- User wants a check every 2 hours starting at 9:00 AM
- Set `interval_unit` to "hours"
- Set `interval_value` to 2
- Set `start_time` to "09:00"
- Will trigger at: 09:00, 11:00, 13:00, 15:00, etc.

**Note**: The system supports both approaches, with the flexible system taking precedence if all parameters are provided.

---

## Email Service Components

The Email Service provides email sending capabilities for notifications and messages.

### 1. Send Email (`send_email`)

**Purpose**: Sends a real email to a specified recipient when triggered via SMTP.

**Type**: REACTION

**Description**: Sends customizable emails via SMTP (currently configured for Gmail). Supports dynamic recipient addresses, subjects, and message bodies. This is the production email service that actually sends real emails.

**Database Configuration**:

#### Service Record
```sql
INSERT INTO services (name, description, icon_path, requires_auth, is_active) 
VALUES ('Email', 'Send email notifications and messages', '/icons/email.svg', false, true);
```

#### Component Record
```sql
INSERT INTO components (service_id, type, name, description, is_active)
VALUES (2, 'reaction', 'send_email', 'Send an email to specified recipient', true);
```

#### Variables Required
| Variable | Type | Required | Description | Example | Validation |
|----------|------|----------|-------------|---------|------------|
| `to` | EMAIL | Yes | Recipient email address | "user@example.com" | `^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$` |
| `subject` | STRING | No | Email subject line | "AREA Notification" | None |
| `body` | STRING | No | Email message content | "Your AREA was triggered successfully." | None |

#### Variable Database Records
```sql
INSERT INTO variables (component_id, name, description, kind, type, nullable, placeholder, validation_regex, display_order) VALUES
(5, 'to', 'Recipient email address', 'parameter', 'email', false, 'user@example.com', '^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$', 1),
(5, 'subject', 'Email subject line', 'parameter', 'string', true, 'AREA Notification', null, 2),
(5, 'body', 'Email message body', 'parameter', 'string', true, 'Your AREA was triggered successfully.', null, 3);
```

**Environment Configuration Required**:
```bash
SMTP_USER=your-gmail-address@gmail.com
SMTP_PASS=your-gmail-app-password
```

**Usage Example**:
- User wants to receive email notifications when timer triggers
- Set `to` to "user@example.com"
- Set `subject` to "Daily Reminder"
- Set `body` to "Don't forget your daily task!"

---

### 2. Fake Email (`fake_email`)

**Purpose**: Simulates sending an email without actually sending it - for development and testing.

**Type**: REACTION

**Description**: A mock email service that logs email details instead of sending actual emails. Used for development, testing, and when SMTP credentials are not configured. Provides the same interface as send_email but without external dependencies.

**Database Configuration**:

#### Component Record
```sql
INSERT INTO components (service_id, type, name, description, is_active)
VALUES (2, 'reaction', 'fake_email', 'Simulate sending an email (development/testing)', true);
```

#### Variables Required
| Variable | Type | Required | Description | Example | Validation |
|----------|------|----------|-------------|---------|------------|
| `to` | EMAIL | Yes | Recipient email address (logged only) | "user@example.com" | `^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$` |
| `subject` | STRING | No | Email subject line (logged only) | "AREA Notification" | None |
| `body` | STRING | No | Email message content (logged only) | "Your AREA was triggered successfully." | None |

#### Variable Database Records
```sql
INSERT INTO variables (component_id, name, description, kind, type, nullable, placeholder, validation_regex, display_order) VALUES
(6, 'to', 'Recipient email address', 'parameter', 'email', false, 'user@example.com', '^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$', 1),
(6, 'subject', 'Email subject line', 'parameter', 'string', true, 'AREA Notification', null, 2),
(6, 'body', 'Email message body', 'parameter', 'string', true, 'Your AREA was triggered successfully.', null, 3);
```

**Usage Example**:
- Developer wants to test email functionality without sending real emails
- Set `to` to "test@example.com"
- Set `subject` to "Test Notification"
- Set `body` to "This is a test message."
- Email details will be logged to console instead of being sent

**Note**: This component is automatically created by the system and shares the same variables as `send_email` but uses the `FakeEmailService` for processing.

---

## Database Structure

### Complete Component Setup

When implementing components, you need to modify these tables in order:

#### 1. Services Table
```sql
CREATE TABLE services (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) UNIQUE NOT NULL,
  description TEXT,
  icon_path VARCHAR(255),
  requires_auth BOOLEAN DEFAULT false,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### 2. Components Table
```sql
CREATE TABLE components (
  id SERIAL PRIMARY KEY,
  service_id INTEGER REFERENCES services(id),
  name VARCHAR(100) NOT NULL,
  type VARCHAR(20) NOT NULL CHECK (type IN ('action', 'reaction')),
  description TEXT,
  is_active BOOLEAN DEFAULT true,
  polling_interval INTEGER, -- For actions only (milliseconds)
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### 3. Variables Table
```sql
CREATE TABLE variables (
  id SERIAL PRIMARY KEY,
  component_id INTEGER REFERENCES components(id),
  name VARCHAR(100) NOT NULL,
  description TEXT,
  kind VARCHAR(20) NOT NULL CHECK (kind IN ('parameter', 'output')),
  type VARCHAR(20) NOT NULL CHECK (type IN ('string', 'email', 'number', 'boolean')),
  nullable BOOLEAN DEFAULT false,
  placeholder VARCHAR(255),
  validation_regex VARCHAR(255),
  display_order INTEGER DEFAULT 1,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### Area Configuration Tables

When users create AREAs, these tables store the configuration:

#### 4. Areas Table
```sql
CREATE TABLE areas (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id),
  component_action_id INTEGER REFERENCES components(id),
  component_reaction_id INTEGER REFERENCES components(id),
  name VARCHAR(255) NOT NULL,
  description TEXT,
  is_active BOOLEAN DEFAULT true,
  last_triggered_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 5. Area Parameters Table
```sql
CREATE TABLE area_parameters (
  area_id INTEGER REFERENCES areas(id),
  variable_id INTEGER REFERENCES variables(id),
  value TEXT NOT NULL,
  PRIMARY KEY (area_id, variable_id)
);
```

### Execution Tracking Tables

#### 6. Area Executions Table
```sql
CREATE TABLE area_executions (
  id SERIAL PRIMARY KEY,
  area_id INTEGER REFERENCES areas(id),
  status VARCHAR(20) NOT NULL CHECK (status IN ('pending', 'success', 'failed')),
  started_at TIMESTAMP DEFAULT NOW(),
  finished_at TIMESTAMP,
  error_message TEXT,
  logs JSONB
);
```

#### 7. Hook States Table (Timer Management)
```sql
CREATE TABLE hook_states (
  id SERIAL PRIMARY KEY,
  area_id INTEGER REFERENCES areas(id),
  component_id INTEGER REFERENCES components(id),
  state_data JSONB,
  last_checked_at TIMESTAMP DEFAULT NOW(),
  last_triggered_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW()
);
```

## Component Implementation Guide

### Adding New Components

To add a new component to the system:

#### 1. Update Services Initializer
Add component creation logic to `src/services/services-initializer.service.ts`:

```typescript
// Create new component
const newComponent = await this.componentsService.create({
  service_id: serviceId,
  type: ComponentType.ACTION, // or REACTION
  name: 'component_name',
  description: 'Component description',
  is_active: true,
  polling_interval: 60000, // For actions only
});

// Create component variables
await this.variablesService.create({
  component_id: newComponent.id,
  name: 'parameter_name',
  description: 'Parameter description',
  kind: VariableKind.PARAMETER,
  type: VariableType.STRING,
  nullable: false,
  placeholder: 'example_value',
  validation_regex: '^[a-zA-Z0-9]+$', // Optional
  display_order: 1,
});
```

#### 2. Update Reaction Processor (if REACTION)
Add handling logic to `src/common/reaction-processor.service.ts`:

```typescript
switch (component.name) {
  case 'new_component':
    await this.newService.processReaction(executionId, areaId);
    break;
  // ... existing cases
}
```

#### 3. Implement Service Logic
Create service in appropriate module:

```typescript
@Injectable()
export class NewService {
  async processReaction(executionId: number, areaId: number): Promise<void> {
    // Get parameters from area configuration
    const parameters = await this.areaParametersService.findByAreaId(areaId);
    
    // Execute reaction logic
    // ...
    
    // Update execution status
    await this.areaExecutionsService.update(executionId, {
      status: ExecutionStatus.SUCCESS,
      finished_at: new Date(),
    });
  }
}
```

#### 4. Register Module
Add new module to `src/app.module.ts`:

```typescript
@Module({
  imports: [
    // ... existing modules
    NewServiceModule,
  ],
  // ...
})
export class AppModule {}
```

### Component Validation

Each component should validate its parameters:

1. **Type Validation**: Ensure parameter types match variable definitions
2. **Required Fields**: Check all non-nullable variables have values
3. **Format Validation**: Apply regex validation where specified
4. **Business Logic**: Validate parameter combinations make sense

### Testing Components

Create tests for each component:

```typescript
describe('NewComponent', () => {
  it('should validate required parameters', () => {
    // Test parameter validation
  });
  
  it('should execute reaction successfully', () => {
    // Test reaction execution
  });
  
  it('should handle errors gracefully', () => {
    // Test error handling
  });
});
```

## Complete Component & Variable Summary

### All Components Currently Initialized

Based on the `services-initializer.service.ts`, these are the components and variables that are automatically created when the system starts:

#### Clock Service Components (4 components)
1. **daily_timer** (ACTION)
   - Variables: `time` (STRING, required)

2. **weekly_timer** (ACTION) 
   - Variables: `time` (STRING, required), `days_of_week` (STRING, required)

3. **monthly_timer** (ACTION)
   - Variables: `time` (STRING, required), `days_of_month` (STRING, required)

4. **interval_timer** (ACTION)
   - Variables: `interval_minutes` (NUMBER, required), `start_time` (STRING, required)

#### Email Service Components (1 component initialized, 1 supported)
1. **send_email** (REACTION) - *Initialized*
   - Variables: `to` (EMAIL, required), `subject` (STRING, optional), `body` (STRING, optional)

2. **fake_email** (REACTION) - *Supported in code but NOT initialized automatically*
   - Variables: Same as send_email (`to`, `subject`, `body`)
   - Note: This component is referenced in `reaction-processor.service.ts` but not created by the initializer

### Total Variable Count
- **Clock Service**: 8 variables across 4 components
- **Email Service**: 3 variables for send_email (fake_email uses same variables)
- **Total Initialized**: 11 variables

### Missing Component Creation
The system code supports but does not automatically create:
1. **fake_email** component - exists in reaction processor but not in initializer
2. **Extended interval timer variables** - `interval_unit` and `interval_value` are supported in clock.service.ts but not created

### Database Impact
When the system initializes, it creates:
- **2 Services** (Clock, Email)
- **5 Components** (4 clock actions + 1 email reaction)
- **11 Variables** (distributed across the components)

### Extension Points
To add the missing components or variables:
1. Add fake_email component creation to `createEmailService()` method
2. Add interval_unit and interval_value variables to interval_timer component
3. Create new services following the same pattern

---

This documentation provides complete information for implementing and configuring all AREA system components. Each component is fully documented with its purpose, database requirements, and usage examples.